'''
This script automatically finds JSON result files in the results directory
(generated by running uav.py) and creates separate KPI comparison plots.

Usage:
    python compare_algorithms.py
'''

import json
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import os
import glob

def load_results_from_directory(results_dir="results"):
    '''
    Load all JSON result files from the results directory.
    Returns a dictionary mapping algorithm names to DataFrames.
    '''
    # Get the directory where this script is located
    script_dir = os.path.dirname(os.path.abspath(__file__))
    # Resolve results directory relative to script location
    results_path = os.path.join(script_dir, results_dir)
    
    # Check if results directory exists relative to script
    if not os.path.exists(results_path):
        # Try current working directory as fallback
        cwd_results = os.path.join(os.getcwd(), results_dir)
        if os.path.exists(cwd_results):
            results_path = cwd_results
        else:
            raise FileNotFoundError(
                f"Results directory not found.\n"
                f"  Checked: {results_path}\n"
                f"  Also checked: {cwd_results}\n"
                f"  Current working directory: {os.getcwd()}\n"
                f"  Script location: {script_dir}\n"
                f"Please ensure 'results' directory exists with JSON result files."
            )
    
    print(f"Looking for result files in: {results_path}")
    
    # Find all JSON files in results directory
    json_files = glob.glob(os.path.join(results_path, "*_results.json"))
    
    if not json_files:
        # List what files are actually in the directory for debugging
        existing_files = os.listdir(results_path) if os.path.exists(results_path) else []
        raise FileNotFoundError(
            f"No result files (*_results.json) found in '{results_path}' directory.\n"
            f"  Existing files: {existing_files}\n"
            f"Please run uav.py for each algorithm first to generate result files."
        )
    
    dataframes = {}
    algorithm_names = []
    
    for json_file in json_files:
        try:
            with open(json_file, 'r') as f:
                data = json.load(f)
            
            algorithm_name = data.get('algorithm', 'Unknown')
            
            # Create DataFrame from the data
            df = pd.DataFrame({
                'episode': data.get('episodes', []),
                'reward': data.get('rewards', []),
                'flight_time': data.get('flight_times', []),
                'terminated': data.get('terminated', [])
            })
            
            # Add summary statistics as attributes
            df.attrs = {
                'algorithm': algorithm_name,
                'num_episodes': data.get('num_episodes', len(df)),
                'avg_reward': data.get('avg_reward', df['reward'].mean()),
                'std_reward': data.get('std_reward', df['reward'].std()),
                'min_reward': data.get('min_reward', df['reward'].min()),
                'max_reward': data.get('max_reward', df['reward'].max()),
                'success_rate': data.get('success_rate', df['terminated'].sum() / len(df) * 100),
                'avg_flight_time': data.get('avg_flight_time', df['flight_time'].mean())
            }
            
            dataframes[algorithm_name] = df
            algorithm_names.append(algorithm_name)
            
            print(f"Loaded {algorithm_name}: {len(df)} episodes")
            
        except Exception as e:
            print(f"Warning: Could not load {json_file}: {e}")
            continue
    
    # Check if we have the expected algorithms
    expected_algorithms = ['Random Action', 'SARSA', 'Q-Learning']
    missing = [alg for alg in expected_algorithms if alg not in dataframes]
    
    if missing:
        print(f"\nWarning: Missing algorithms: {', '.join(missing)}")
        print(f"Found algorithms: {', '.join(dataframes.keys())}")
    
    return dataframes

def create_kpi_plots(dataframes, output_dir="results/plots"):
    '''
    Create separate KPI plots from pandas DataFrames.
    Each KPI is saved as a separate PNG file.
    
    dataframes: Dictionary mapping algorithm names to DataFrames
    output_dir: Directory to save plots
    '''
    # Get the directory where this script is located
    script_dir = os.path.dirname(os.path.abspath(__file__))
    # Resolve output directory relative to script location
    output_path = os.path.join(script_dir, output_dir)
    os.makedirs(output_path, exist_ok=True)
    
    # Algorithm colors
    colors = {
        'Random Action': 'red',
        'SARSA': 'blue',
        'Q-Learning': 'green'
    }
    
    # Prepare summary DataFrame for easier plotting
    summary_data = []
    for algo_name, df in dataframes.items():
        attrs = df.attrs
        summary_data.append({
            'algorithm': attrs['algorithm'],
            'avg_reward': attrs['avg_reward'],
            'std_reward': attrs['std_reward'],
            'min_reward': attrs['min_reward'],
            'max_reward': attrs['max_reward'],
            'success_rate': attrs['success_rate'],
            'avg_flight_time': attrs['avg_flight_time']
        })
    
    summary_df = pd.DataFrame(summary_data)
    
    # KPI 1: Reward After Episodes (Learning Curve)
    fig1, ax1 = plt.subplots(figsize=(12, 6))
    for algo_name, df in dataframes.items():
        # Calculate moving average for smoother plot
        window = max(1, len(df) // 100)
        if window > 1:
            df_smooth = df.copy()
            df_smooth['reward_ma'] = df_smooth['reward'].rolling(window=window, center=False).mean()
            df_smooth = df_smooth[window-1:]  # Remove NaN values
            ax1.plot(df_smooth['episode'], df_smooth['reward_ma'], 
                    label=algo_name, color=colors.get(algo_name, 'black'), 
                    alpha=0.7, linewidth=2)
        else:
            ax1.plot(df['episode'], df['reward'], 
                    label=algo_name, color=colors.get(algo_name, 'black'), 
                    alpha=0.7, linewidth=2)
    
    ax1.set_xlabel('Episode', fontsize=12)
    ax1.set_ylabel('Reward', fontsize=12)
    ax1.set_title('KPI 1: Reward After Episodes', fontsize=14, fontweight='bold')
    ax1.legend(fontsize=11)
    ax1.grid(True, alpha=0.3)
    plt.tight_layout()
    fig1.savefig(os.path.join(output_path, 'KPI1.png'), dpi=300, bbox_inches='tight')
    plt.close(fig1)
    print(f"Saved KPI1.png: Reward After Episodes")
    
    # KPI 2: Average Flying Time
    fig2, ax2 = plt.subplots(figsize=(10, 6))
    bars = ax2.bar(summary_df['algorithm'], summary_df['avg_flight_time'], 
                   color=[colors.get(name, 'gray') for name in summary_df['algorithm']], 
                   alpha=0.7)
    ax2.set_ylabel('Average Flight Time (steps)', fontsize=12)
    ax2.set_title('KPI 2: Average Flying Time', fontsize=14, fontweight='bold')
    ax2.axhline(y=50, color='r', linestyle='--', alpha=0.5, label='Target (50 steps)')
    ax2.grid(True, alpha=0.3, axis='y')
    ax2.tick_params(axis='x', rotation=45)
    ax2.legend(fontsize=10)
    
    # Add value labels on bars
    for bar, avg_time in zip(bars, summary_df['avg_flight_time']):
        height = bar.get_height()
        ax2.text(bar.get_x() + bar.get_width()/2., height,
                f'{avg_time:.1f}', ha='center', va='bottom', fontsize=11)
    
    plt.tight_layout()
    fig2.savefig(os.path.join(output_path, 'KPI2.png'), dpi=300, bbox_inches='tight')
    plt.close(fig2)
    print(f"Saved KPI2.png: Average Flying Time")
    
    # KPI 3: Average Reward
    fig3, ax3 = plt.subplots(figsize=(10, 6))
    bars = ax3.bar(summary_df['algorithm'], summary_df['avg_reward'], 
                   color=[colors.get(name, 'gray') for name in summary_df['algorithm']], 
                   alpha=0.7)
    ax3.set_ylabel('Average Reward', fontsize=12)
    ax3.set_title('KPI 3: Average Reward', fontsize=14, fontweight='bold')
    ax3.grid(True, alpha=0.3, axis='y')
    ax3.tick_params(axis='x', rotation=45)
    
    # Add value labels on bars
    for bar, avg in zip(bars, summary_df['avg_reward']):
        height = bar.get_height()
        ax3.text(bar.get_x() + bar.get_width()/2., height,
                f'{avg:.2f}', ha='center', va='bottom', fontsize=11)
    
    plt.tight_layout()
    fig3.savefig(os.path.join(output_path, 'KPI3.png'), dpi=300, bbox_inches='tight')
    plt.close(fig3)
    print(f"Saved KPI3.png: Average Reward")
    
    # KPI 4: Min Max Reward Range
    fig4, ax4 = plt.subplots(figsize=(10, 6))
    x_pos = np.arange(len(summary_df))
    width = 0.25
    
    bars_min = ax4.bar(x_pos - width, summary_df['min_reward'], width, 
            label='Min', alpha=0.7, color='lightcoral')
    bars_avg = ax4.bar(x_pos, summary_df['avg_reward'], width, 
            label='Average', alpha=0.7, color='steelblue')
    bars_max = ax4.bar(x_pos + width, summary_df['max_reward'], width, 
            label='Max', alpha=0.7, color='lightgreen')
    
    ax4.set_ylabel('Reward', fontsize=12)
    ax4.set_title('KPI 4: Min Max Reward Range', fontsize=14, fontweight='bold')
    ax4.set_xticks(x_pos)
    ax4.set_xticklabels(summary_df['algorithm'], rotation=45, ha='right')
    ax4.legend(fontsize=10)
    ax4.grid(True, alpha=0.3, axis='y')
    
    # Add value labels on bars
    for bars_group in [bars_min, bars_avg, bars_max]:
        for bar in bars_group:
            height = bar.get_height()
            ax4.text(bar.get_x() + bar.get_width()/2., height,
                    f'{height:.2f}', ha='center', va='bottom', fontsize=9)
    
    plt.tight_layout()
    fig4.savefig(os.path.join(output_path, 'KPI4.png'), dpi=300, bbox_inches='tight')
    plt.close(fig4)
    print(f"Saved KPI4.png: Min Max Reward Range")
    
    # KPI 5: Success Rate
    fig5, ax5 = plt.subplots(figsize=(10, 6))
    bars = ax5.bar(summary_df['algorithm'], summary_df['success_rate'], 
                   color=[colors.get(name, 'gray') for name in summary_df['algorithm']], 
                   alpha=0.7)
    ax5.set_ylabel('Success Rate (%)', fontsize=12)
    ax5.set_title('KPI 5: Success Rate', fontsize=14, fontweight='bold')
    ax5.set_ylim([0, 100])
    ax5.grid(True, alpha=0.3, axis='y')
    ax5.tick_params(axis='x', rotation=45)
    
    # Add value labels on bars
    for bar, rate in zip(bars, summary_df['success_rate']):
        height = bar.get_height()
        ax5.text(bar.get_x() + bar.get_width()/2., height,
                f'{rate:.1f}%', ha='center', va='bottom', fontsize=11)
    
    plt.tight_layout()
    fig5.savefig(os.path.join(output_path, 'KPI5.png'), dpi=300, bbox_inches='tight')
    plt.close(fig5)
    print(f"Saved KPI5.png: Success Rate")
    
    print(f"\nAll KPI plots saved to {output_path}/")

if __name__ == "__main__":
    print("="*70)
    print("Algorithm Comparison - KPI Analysis")
    print("="*70)
    print("\nSearching for result files in 'results' directory...")
    
    try:
        # Load all results from results directory
        dataframes = load_results_from_directory("results")
        
        if not dataframes:
            raise ValueError("No valid result files found in 'results' directory.")
        
        print(f"\nFound {len(dataframes)} algorithm(s): {', '.join(dataframes.keys())}")
        
        print("\n" + "="*70)
        print("Creating KPI comparison plots...")
        print("="*70)
        
        # Create plots
        create_kpi_plots(dataframes)
        
        print("\n" + "="*70)
        print("Comparison complete!")
        print("="*70)
        print(f"\nAll KPI plots saved in: results/plots/")
        print("  - KPI1.png: Reward After Episodes")
        print("  - KPI2.png: Average Flying Time")
        print("  - KPI3.png: Average Reward")
        print("  - KPI4.png: Min Max Reward Range")
        print("  - KPI5.png: Success Rate")
        
    except FileNotFoundError as e:
        print(f"\nError: {e}")
        print("\nPlease run uav.py for each algorithm first to generate result files.")
        print("Expected files in 'results' directory:")
        print("  - Random_Action_results.json")
        print("  - SARSA_results.json")
        print("  - Q_Learning_results.json")
        exit(1)
    except Exception as e:
        print(f"\nError: {e}")
        import traceback
        traceback.print_exc()
        exit(1)
